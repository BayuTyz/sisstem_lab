<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Total Biaya - MediLab</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/dashboard"
          ><i class="fas fa-flask"></i> MediLab</a
        >
        <div class="navbar-nav">
          <a class="nav-link" href="/dashboard">Dashboard</a>
          <a class="nav-link" href="/pembayaran">Pembayaran</a>
          <a class="nav-link active" href="/total-biaya">Total Biaya</a>
          <a class="nav-link" href="/logout">Logout</a>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <h3><i class="fas fa-chart-line me-2"></i>Laporan Total Biaya</h3>

      <!-- Filter -->
      <div class="card mb-3">
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <label>Periode Dari</label>
              <input
                type="date"
                class="form-control"
                id="startDate"
                value="<?php echo date('Y-m-01'); ?>"
              />
            </div>
            <div class="col-md-3">
              <label>Periode Sampai</label>
              <input
                type="date"
                class="form-control"
                id="endDate"
                value="<?php echo date('Y-m-d'); ?>"
              />
            </div>
            <div class="col-md-3">
              <label>Jenis Laporan</label>
              <select class="form-select" id="reportType">
                <option value="daily">Harian</option>
                <option value="monthly">Bulanan</option>
                <option value="yearly">Tahunan</option>
              </select>
            </div>
            <div class="col-md-3">
              <label>&nbsp;</label><br />
              <button class="btn btn-primary w-100" onclick="loadReport()">
                <i class="fas fa-filter"></i> Filter
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Statistik -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-white bg-primary">
            <div class="card-body">
              <h5>Total Pendapatan</h5>
              <h3 id="totalRevenue">Rp 0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-success">
            <div class="card-body">
              <h5>Pembayaran Lunas</h5>
              <h3 id="paidCount">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-warning">
            <div class="card-body">
              <h5>Belum Dibayar</h5>
              <h3 id="unpaidCount">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-info">
            <div class="card-body">
              <h5>Rata-rata/Transaksi</h5>
              <h3 id="avgTransaction">Rp 0</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart -->
      <div class="row mb-4">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Grafik Pendapatan</h5>
            </div>
            <div class="card-body">
              <canvas id="revenueChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Metode Pembayaran</h5>
            </div>
            <div class="card-body">
              <canvas id="paymentMethodChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabel Detail -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Detail Transaksi</h5>
        </div>
        <div class="card-body">
          <table id="transactionsTable" class="table table-striped">
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>Kode Pemeriksaan</th>
                <th>Pasien</th>
                <th>Jenis Pemeriksaan</th>
                <th>Metode Bayar</th>
                <th>Jumlah</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <!-- Data akan diisi oleh JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tombol Ekspor -->
      <div class="mt-3 text-end">
        <button class="btn btn-success" onclick="exportToExcel()">
          <i class="fas fa-file-excel"></i> Export ke Excel
        </button>
        <button class="btn btn-danger" onclick="printReport()">
          <i class="fas fa-print"></i> Cetak Laporan
        </button>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
      let revenueChart, methodChart;
      let transactionsData = [];

      // Load laporan
      function loadReport() {
        let params = {
          start_date: $("#startDate").val(),
          end_date: $("#endDate").val(),
          report_type: $("#reportType").val(),
        };

        $.ajax({
          url: "/api/payment/report",
          method: "GET",
          data: params,
          success: function (data) {
            transactionsData = data.transactions || [];
            updateStatistics(data.stats || {});
            updateCharts(data.chart_data || {});
            updateTable();
          },
        });
      }

      // Update statistik
      function updateStatistics(stats) {
        $("#totalRevenue").text(
          "Rp " + (stats.total_revenue || 0).toLocaleString()
        );
        $("#paidCount").text(stats.paid_count || 0);
        $("#unpaidCount").text(stats.unpaid_count || 0);
        $("#avgTransaction").text(
          "Rp " + (stats.avg_transaction || 0).toLocaleString()
        );
      }

      // Update chart
      function updateCharts(chartData) {
        // Revenue Chart
        if (revenueChart) revenueChart.destroy();

        let ctx1 = document.getElementById("revenueChart").getContext("2d");
        revenueChart = new Chart(ctx1, {
          type: "line",
          data: {
            labels: chartData.labels || [],
            datasets: [
              {
                label: "Pendapatan (Rp)",
                data: chartData.revenue || [],
                borderColor: "#0d6efd",
                backgroundColor: "rgba(13, 110, 253, 0.1)",
                tension: 0.3,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: "Trend Pendapatan",
              },
            },
          },
        });

        // Payment Method Chart
        if (methodChart) methodChart.destroy();

        let ctx2 = document
          .getElementById("paymentMethodChart")
          .getContext("2d");
        methodChart = new Chart(ctx2, {
          type: "doughnut",
          data: {
            labels: chartData.method_labels || [],
            datasets: [
              {
                data: chartData.method_data || [],
                backgroundColor: [
                  "#0d6efd", // Tunai
                  "#198754", // Transfer
                  "#ffc107", // E-Wallet
                  "#6f42c1", // BPJS
                ],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      // Update tabel
      function updateTable() {
        let table = $("#transactionsTable").DataTable();
        table.clear();

        transactionsData.forEach(function (transaction) {
          let statusBadge = "";
          switch (transaction.payment_status) {
            case "paid":
              statusBadge = '<span class="badge bg-success">Lunas</span>';
              break;
            case "unpaid":
              statusBadge = '<span class="badge bg-warning">Belum Bayar</span>';
              break;
            case "partial":
              statusBadge = '<span class="badge bg-info">Sebagian</span>';
              break;
          }

          table.row.add([
            transaction.payment_date,
            transaction.examination_code || "",
            transaction.patient_name || "",
            transaction.examination_type || "",
            transaction.payment_method,
            "Rp " + parseInt(transaction.total_amount || 0).toLocaleString(),
            statusBadge,
          ]);
        });
        table.draw();
      }

      // Export ke Excel
      function exportToExcel() {
        if (transactionsData.length === 0) {
          alert("Tidak ada data untuk diexport!");
          return;
        }

        // Format data untuk Excel
        let excelData = [
          ["Laporan Total Biaya MediLab"],
          ["Periode: " + $("#startDate").val() + " s/d " + $("#endDate").val()],
          [],
          ["Tanggal", "Kode", "Pasien", "Jenis", "Metode", "Jumlah", "Status"],
        ];

        transactionsData.forEach(function (t) {
          excelData.push([
            t.payment_date,
            t.examination_code || "",
            t.patient_name || "",
            t.examination_type || "",
            t.payment_method,
            t.total_amount,
            t.payment_status,
          ]);
        });

        // Buat worksheet
        let ws = XLSX.utils.aoa_to_sheet(excelData);
        let wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Laporan");

        // Export
        XLSX.writeFile(
          wb,
          `Laporan_MediLab_${new Date().toISOString().split("T")[0]}.xlsx`
        );
      }

      // Cetak laporan
      function printReport() {
        window.print();
      }

      $(document).ready(function () {
        $("#transactionsTable").DataTable();
        loadReport(); // Load data default

        // Set default dates
        let today = new Date();
        let firstDay = new Date(today.getFullYear(), today.getMonth(), 1);

        $("#startDate").val(firstDay.toISOString().split("T")[0]);
        $("#endDate").val(today.toISOString().split("T")[0]);
      });
    </script>

    <style>
      @media print {
        .navbar,
        button,
        .card-header button,
        .text-end {
          display: none !important;
        }
        .card {
          border: none !important;
          box-shadow: none !important;
        }
        .card-header {
          background: white !important;
          color: black !important;
          border-bottom: 2px solid #000;
        }
      }
    </style>
  </body>
</html>
